<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VidSlide AI - ç®€åŒ–å·¥ä½œç‰ˆæœ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .env-notice {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 8px 15px;
            margin: 10px 0;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .env-notice strong {
            color: #fff3cd;
        }

        .main-content {
            padding: 20px;
        }

        .status {
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
        }

        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .video-editor {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            margin: 20px 0;
        }

        .main-panel {
            display: grid;
            grid-template-rows: 2fr 1fr;
            gap: 15px;
        }

        .sidebar {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e4e7ed;
        }

        .section {
            border: 1px solid #e4e7ed;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }

        .section h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .file-input {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            width: 100%;
            background: white;
        }

        .file-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }

        .video-player {
            width: 100%;
            max-height: 300px;
            border-radius: 4px;
            background: #000;
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .timeline {
            width: 100%;
            height: 60px;
            background: #f0f0f0;
            border-radius: 4px;
            position: relative;
            margin: 10px 0;
            cursor: pointer;
        }

        .timeline-progress {
            height: 100%;
            background: #007bff;
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s;
        }

        .marker {
            position: absolute;
            top: -6px;
            width: 12px;
            height: 30px;
            background: #dc3545;
            border-radius: 2px;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .primary { background: #007bff; color: white; }
        .primary:hover { background: #0056b3; }

        .success-btn { background: #28a745; color: white; }
        .success-btn:hover { background: #218838; }

        .danger { background: #dc3545; color: white; }
        .danger:hover { background: #c82333; }

        .secondary { background: #6c757d; color: white; }
        .secondary:hover { background: #545b62; }

        .marker-list {
            margin: 10px 0;
            max-height: 100px;
            overflow-y: auto;
        }

        .marker-item {
            padding: 3px 6px;
            margin: 2px 0;
            background: #e9ecef;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 12px;
        }

        .marker-item:hover {
            background: #dee2e6;
        }

        .marker-item.selected {
            background: #007bff;
            color: white;
        }

        .tabs {
            margin: 15px 0;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 10px;
        }

        .tab-btn {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
            font-size: 12px;
        }

        .tab-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .tab-btn:not(.active):hover {
            background: #f8f9fa;
        }

        .tab-content {
            padding: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .ai-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin: 8px 0;
        }

        .debug-info {
            font-size: 11px;
            color: #666;
            margin-top: 15px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .test-result {
            margin: 3px 0;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 11px;
        }

        @media (max-width: 768px) {
            .video-editor {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
                gap: 15px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            button {
                margin: 2px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ¬ VidSlide AI - ç®€åŒ–å·¥ä½œç‰ˆæœ¬</h1>
            <p>çº¯JavaScriptå®ç°ï¼Œç¨³å®šå¯é </p>
            <div id="envNotice" class="env-notice" style="display:none;">
                <strong>ğŸ¯ è¯­éŸ³è¯†åˆ«æç¤º:</strong> å½“å‰ä½¿ç”¨æ–‡ä»¶åè®®ï¼Œè¯­éŸ³è¯†åˆ«åŠŸèƒ½å—é™ã€‚
                <br>å»ºè®®: <code style="background: rgba(0,0,0,0.2); padding: 2px 4px; border-radius: 2px;">python -m http.server 8000</code>
                ç„¶åè®¿é—® <code style="background: rgba(0,0,0,0.2); padding: 2px 4px; border-radius: 2px;">http://localhost:8000/vidslide-simple.html</code>
            </div>
        </div>

        <!-- æµ‹è¯•ç»“æœçŠ¶æ€ -->
        <div class="main-content">
            <div id="test-results"></div>

            <!-- è§†é¢‘ç¼–è¾‘å™¨ -->
            <div class="video-editor">
                <!-- ä¸»è¦é¢æ¿ -->
                <div class="main-panel">
                    <!-- è§†é¢‘ä¸Šä¼ å’Œæ’­æ”¾åŒºåŸŸ -->
                    <div class="section">
                        <h2>ğŸ“ è§†é¢‘ä¸Šä¼  & ğŸ¥ æ’­æ”¾å™¨</h2>
                        <input type="file" accept="video/*" id="videoFileInput" onchange="handleVideoSelect()" class="file-input">
                        <div id="videoFileInfo" class="file-info status warning">
                            <p>è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶</p>
                        </div>

                        <div id="videoPlayerSection" style="display:none; margin-top: 15px;">
                            <video
                                id="videoPlayer"
                                controls
                                onloadedmetadata="handleVideoLoaded()"
                                ontimeupdate="handleTimeUpdate()"
                                onplay="handlePlay()"
                                onpause="handlePause()"
                                class="video-player"
                            ></video>
                            <div class="controls">
                                <button class="primary" onclick="playVideo()" id="playBtn">â–¶ï¸ æ’­æ”¾</button>
                                <button class="primary" onclick="pauseVideo()" id="pauseBtn">â¸ï¸ æš‚åœ</button>
                                <button class="secondary" onclick="seekVideo(10)">â© +10ç§’</button>
                                <button class="secondary" onclick="seekVideo(-10)">âª -10ç§’</button>
                                <span id="timeDisplay">æ—¶é—´: 00:00 / 00:00</span>
                            </div>
                        </div>

                        <div style="margin-top: 10px;">
                            <button class="danger" onclick="resetVideo()" id="resetBtn" style="display:none;">é‡ç½®è§†é¢‘</button>
                        </div>
                    </div>

                    <!-- æ—¶é—´è½´åŒºåŸŸ -->
                    <div id="timelineSection" style="display:none;" class="section">
                        <h2>â±ï¸ æ—¶é—´è½´ & ğŸ“ æ ‡è®°</h2>
                        <div class="timeline" onclick="handleTimelineClick(event)">
                            <div class="timeline-progress" id="timelineProgress"></div>
                            <!-- æ—¶é—´è½´æ ‡è®° -->
                            <div id="timelineMarkers"></div>
                        </div>
                        <div class="controls">
                            <button class="success-btn" onclick="addMarker()">â• æ·»åŠ æ ‡è®°</button>
                            <button class="danger" onclick="removeMarker()" id="removeMarkerBtn" disabled>ğŸ—‘ï¸ åˆ é™¤æ ‡è®°</button>
                            <span id="markerCount">æ ‡è®°æ•°é‡: 0</span>
                            <span id="selectedMarkerInfo"></span>
                        </div>
                        <div id="markerList" class="marker-list"></div>
                    </div>
                </div>

                <!-- ä¾§è¾¹æ  - AIåŠŸèƒ½ -->
                <div class="sidebar">
                    <h2>ğŸ¤– AIåŠŸèƒ½é¢æ¿</h2>

                    <!-- é€‰é¡¹å¡ -->
                    <div class="tabs">
                        <div class="tab-buttons">
                            <button class="tab-btn active" onclick="switchTab('transcription')">ğŸ¤ è¯­éŸ³è½¬æ–‡å­—</button>
                            <button class="tab-btn" onclick="switchTab('face')">ğŸ‘¤ äººè„¸è·Ÿè¸ª</button>
                            <button class="tab-btn" onclick="switchTab('pip')">ğŸ¨ ç”»ä¸­ç”»</button>
                            <button class="tab-btn" onclick="switchTab('recommendation')">ğŸ’¡ æ™ºèƒ½æ¨è</button>
                            <button class="tab-btn" onclick="switchTab('compatibility')">ğŸ”§ å…¼å®¹æ€§</button>
                        </div>

                        <div id="tab-transcription" class="tab-content">
                            <div class="ai-section">
                                <h3>ğŸ¤ è¯­éŸ³è½¬æ–‡å­—</h3>
                                <p>ä½¿ç”¨Web Speech APIè¿›è¡Œå®æ—¶è¯­éŸ³è¯†åˆ«</p>
                                <div style="margin-top: 8px;">
                                    <button class="primary" onclick="startSpeechRecognition()" id="speechBtn">ğŸ¤ å¼€å§‹å½•éŸ³</button>
                                    <button class="secondary" onclick="stopSpeechRecognition()" id="speechStopBtn" style="display:none;">â¹ï¸ åœæ­¢å½•éŸ³</button>
                                </div>
                                <div id="speechStatus" style="margin-top: 5px; font-size: 10px; color: #fff;"></div>
                                <div id="speechResult" style="margin-top: 5px; padding: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; font-size: 11px; min-height: 30px;"></div>

                                <!-- éº¦å…‹é£æƒé™æµ‹è¯• -->
                                <div style="margin-top: 8px;">
                                    <button class="secondary" onclick="testMicrophonePermission()" id="micTestBtn">ğŸ” æµ‹è¯•éº¦å…‹é£æƒé™</button>
                                    <div id="micTestResult" style="margin-top: 4px; font-size: 10px;"></div>
                                </div>

                                <!-- æ‰‹åŠ¨è¾“å…¥å¤‡é€‰æ–¹æ¡ˆ -->
                                <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                                    <div style="font-size: 10px; margin-bottom: 4px; color: #fff;">ğŸ’¡ å¦‚æœè¯­éŸ³è¯†åˆ«ä¸å¯ç”¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥:</div>
                                    <textarea id="manualTranscript" placeholder="åœ¨è¿™é‡Œè¾“å…¥è½¬å½•æ–‡å­—..." style="width: 100%; min-height: 40px; padding: 4px; border: none; border-radius: 2px; font-size: 11px; resize: vertical;"></textarea>
                                    <button class="success-btn" onclick="saveManualTranscript()" style="margin-top: 4px; padding: 4px 8px; font-size: 10px;">ğŸ’¾ ä¿å­˜æ‰‹åŠ¨è¾“å…¥</button>
                                </div>
                            </div>
                        </div>

                        <div id="tab-face" class="tab-content" style="display:none;">
                            <div class="ai-section" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                <h3>ğŸ‘¤ äººè„¸è·Ÿè¸ª</h3>
                                <p>äººè„¸æ£€æµ‹å’Œè·Ÿè¸ªåŠŸèƒ½</p>
                                <div style="margin-top: 8px;">
                                    <button class="primary" onclick="initializeFaceTracking()" id="faceBtn">ğŸš€ åˆå§‹åŒ–äººè„¸è·Ÿè¸ª</button>
                                </div>
                                <div id="faceResult" style="margin-top: 8px; padding: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; font-size: 11px;"></div>
                            </div>
                        </div>

                        <div id="tab-pip" class="tab-content" style="display:none;">
                            <div class="ai-section" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                                <h3>ğŸ¨ ç”»ä¸­ç”»æ•ˆæœ</h3>
                                <p>åŠ¨æ€è§†è§‰æ•ˆæœå’ŒåŠ¨ç”»</p>
                                <div style="margin-top: 8px;">
                                    <button class="primary" onclick="applyPictureInPicture()" id="pipBtn">ğŸ¬ åº”ç”¨ç”»ä¸­ç”»æ•ˆæœ</button>
                                </div>
                                <div id="pipResult" style="margin-top: 8px; padding: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; font-size: 11px;"></div>
                            </div>
                        </div>

                        <div id="tab-recommendation" class="tab-content" style="display:none;">
                            <div class="ai-section" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                                <h3>ğŸ’¡ æ™ºèƒ½æ¨è</h3>
                                <p>åŸºäºå†…å®¹åˆ†æçš„PPTç”Ÿæˆå»ºè®®</p>
                                <div style="margin-top: 8px;">
                                    <button class="primary" onclick="generateRecommendations()" id="recBtn">ğŸ§  ç”Ÿæˆæ¨è</button>
                                </div>
                                <div id="recResult" style="margin-top: 8px; padding: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; font-size: 11px;"></div>
                            </div>
                        </div>

                        <div id="tab-compatibility" class="tab-content" style="display:none;">
                            <div class="ai-section" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
                                <h3>ğŸ”§ å…¼å®¹æ€§æ£€æŸ¥</h3>
                                <p>æ£€æŸ¥æµè§ˆå™¨åŠŸèƒ½æ”¯æŒ</p>
                                <div style="margin-top: 8px;">
                                    <button class="primary" onclick="checkCompatibility()">ğŸ” æ£€æŸ¥å…¼å®¹æ€§</button>
                                </div>
                                <div id="compatResult" style="margin-top: 8px; padding: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; font-size: 10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è°ƒè¯•ä¿¡æ¯ -->
            <div class="debug-info">
                <h3>ğŸ”§ è°ƒè¯•ä¿¡æ¯</h3>
                <div id="debugInfo">
                    <p>è§†é¢‘æ–‡ä»¶: æœªé€‰æ‹©</p>
                    <p>å½“å‰æ—¶é—´: 0 (number)</p>
                    <p>è§†é¢‘æ—¶é•¿: 0</p>
                    <p>æ’­æ”¾çŠ¶æ€: æš‚åœä¸­</p>
                    <p>æ ‡è®°æ•°é‡: 0</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€å˜é‡
        let currentVideoFile = null;
        let videoSrc = '';
        let currentTime = 0;
        let videoDuration = 0;
        let isPlaying = false;
        let canPlay = false;
        let markers = [];
        let selectedMarkerId = '';
        let markerIdCounter = 1;

        // AIåŠŸèƒ½çŠ¶æ€
        let activeTab = 'transcription';
        let isRecording = false;
        let speechText = '';
        let faceTrackingInitialized = false;
        let detectedFaces = 0;
        let pipApplied = false;
        let recommendations = [];

        // è¯­éŸ³è¯†åˆ«
        let recognition = null;

        // æµ‹è¯•ç»“æœæ˜¾ç¤º
        function addTestResult(message, type = 'info') {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `status test-result ${type}`;
            div.innerHTML = `<small>${new Date().toLocaleTimeString()}</small><br>${message}`;
            results.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // è°ƒè¯•ä¿¡æ¯æ›´æ–°
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML = `
                <p>è§†é¢‘æ–‡ä»¶: ${currentVideoFile ? 'å·²é€‰æ‹©' : 'æœªé€‰æ‹©'}</p>
                <p>å½“å‰æ—¶é—´: ${currentTime} (${typeof currentTime})</p>
                <p>è§†é¢‘æ—¶é•¿: ${videoDuration}</p>
                <p>æ’­æ”¾çŠ¶æ€: ${isPlaying ? 'æ’­æ”¾ä¸­' : 'æš‚åœä¸­'}</p>
                <p>æ ‡è®°æ•°é‡: ${markers.length}</p>
            `;
        }

        // æ–‡ä»¶å¤§å°æ ¼å¼åŒ–
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ—¶é—´æ ¼å¼åŒ–
        function formatTime(seconds) {
            if (typeof seconds !== 'number' || isNaN(seconds)) return '00:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTimeDisplay() {
            const timeDisplay = document.getElementById('timeDisplay');
            timeDisplay.textContent = `æ—¶é—´: ${formatTime(currentTime)} / ${formatTime(videoDuration)}`;
        }

        // æ›´æ–°æ—¶é—´è½´è¿›åº¦
        function updateTimelineProgress() {
            const progress = document.getElementById('timelineProgress');
            const percentage = videoDuration > 0 ? (currentTime / videoDuration) * 100 : 0;
            progress.style.width = percentage + '%';
        }

        // æ›´æ–°æ ‡è®°æ˜¾ç¤º
        function updateMarkers() {
            const markersContainer = document.getElementById('timelineMarkers');
            markersContainer.innerHTML = '';

            markers.forEach(marker => {
                const markerElement = document.createElement('div');
                markerElement.className = 'marker';
                const percentage = videoDuration > 0 ? (marker.time / videoDuration) * 100 : 0;
                markerElement.style.left = percentage + '%';
                markerElement.onclick = (e) => {
                    e.stopPropagation();
                    selectMarker(marker.id);
                };
                markersContainer.appendChild(markerElement);
            });
        }

        // æ›´æ–°æ ‡è®°åˆ—è¡¨
        function updateMarkerList() {
            const markerList = document.getElementById('markerList');
            const markerCount = document.getElementById('markerCount');

            markerCount.textContent = `æ ‡è®°æ•°é‡: ${markers.length}`;

            if (markers.length > 0) {
                markerList.innerHTML = '<div style="font-size:11px; margin-bottom:5px;"><strong>æ ‡è®°åˆ—è¡¨:</strong></div>';
                markers.forEach(marker => {
                    const div = document.createElement('div');
                    div.className = 'marker-item' + (marker.id === selectedMarkerId ? ' selected' : '');
                    div.textContent = `æ ‡è®° ${marker.id}: ${formatTime(marker.time)}`;
                    div.onclick = () => selectMarker(marker.id);
                    markerList.appendChild(div);
                });
            } else {
                markerList.innerHTML = '';
            }

            document.getElementById('removeMarkerBtn').disabled = !selectedMarkerId;
        }

        // é€‰æ‹©æ ‡è®°
        function selectMarker(markerId) {
            selectedMarkerId = markerId;
            const selectedMarkerInfo = document.getElementById('selectedMarkerInfo');

            if (markerId) {
                const marker = markers.find(m => m.id === markerId);
                selectedMarkerInfo.textContent = `é€‰ä¸­: æ ‡è®°${markerId}`;
                seekToTime(marker.time);
            } else {
                selectedMarkerInfo.textContent = '';
            }

            updateMarkerList();
        }

        // å¤„ç†è§†é¢‘é€‰æ‹©
        function handleVideoSelect() {
            const fileInput = document.getElementById('videoFileInput');
            const file = fileInput.files[0];

            if (file) {
                try {
                    addTestResult(`é€‰æ‹©æ–‡ä»¶: ${file.name}`, 'info');

                    if (!file.type.startsWith('video/')) {
                        addTestResult('è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶', 'error');
                        return;
                    }

                    currentVideoFile = file;
                    videoSrc = URL.createObjectURL(file);

                    const fileInfo = document.getElementById('videoFileInfo');
                    fileInfo.className = 'file-info status success';
                    fileInfo.innerHTML = `
                        <strong>âœ… è§†é¢‘å·²é€‰æ‹©</strong><br>
                        æ–‡ä»¶å: ${file.name}<br>
                        å¤§å°: ${formatFileSize(file.size)}<br>
                        ç±»å‹: ${file.type}
                    `;

                    const videoPlayer = document.getElementById('videoPlayer');
                    videoPlayer.src = videoSrc;

                    document.getElementById('videoPlayerSection').style.display = 'block';
                    document.getElementById('timelineSection').style.display = 'block';
                    document.getElementById('resetBtn').style.display = 'inline-block';

                    addTestResult('âœ… è§†é¢‘æ–‡ä»¶è®¾ç½®æˆåŠŸ', 'success');
                    updateDebugInfo();

                } catch (error) {
                    addTestResult(`âŒ æ–‡ä»¶å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                    console.error('File handling error:', error);
                }
            }
        }

        // é‡ç½®è§†é¢‘
        function resetVideo() {
            if (videoSrc) {
                URL.revokeObjectURL(videoSrc);
            }

            currentVideoFile = null;
            videoSrc = '';
            currentTime = 0;
            videoDuration = 0;
            isPlaying = false;
            canPlay = false;
            markers = [];
            selectedMarkerId = '';

            const fileInfo = document.getElementById('videoFileInfo');
            fileInfo.className = 'file-info status warning';
            fileInfo.innerHTML = '<p>è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶</p>';

            document.getElementById('videoPlayerSection').style.display = 'none';
            document.getElementById('timelineSection').style.display = 'none';
            document.getElementById('resetBtn').style.display = 'none';

            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.src = '';
            videoPlayer.currentTime = 0;

            updateTimeDisplay();
            updateTimelineProgress();
            updateMarkers();
            updateMarkerList();
            updateDebugInfo();

            addTestResult('è§†é¢‘å·²é‡ç½®', 'info');
        }

        // è§†é¢‘åŠ è½½å®Œæˆ
        function handleVideoLoaded() {
            const videoPlayer = document.getElementById('videoPlayer');
            if (videoPlayer) {
                videoDuration = videoPlayer.duration || 0;
                canPlay = true;
                updateTimeDisplay();
                updateTimelineProgress();
                addTestResult(`âœ… è§†é¢‘åŠ è½½å®Œæˆï¼Œæ—¶é•¿: ${formatTime(videoDuration)}`, 'success');
                updateDebugInfo();
            }
        }

        // æ—¶é—´æ›´æ–°
        function handleTimeUpdate() {
            const videoPlayer = document.getElementById('videoPlayer');
            if (videoPlayer) {
                currentTime = videoPlayer.currentTime || 0;
                updateTimeDisplay();
                updateTimelineProgress();
            }
        }

        // æ’­æ”¾äº‹ä»¶
        function handlePlay() {
            isPlaying = true;
            addTestResult('è§†é¢‘å¼€å§‹æ’­æ”¾', 'info');
            updateDebugInfo();
        }

        // æš‚åœäº‹ä»¶
        function handlePause() {
            isPlaying = false;
            addTestResult('è§†é¢‘æš‚åœæ’­æ”¾', 'info');
            updateDebugInfo();
        }

        // æ’­æ”¾æ§åˆ¶
        function playVideo() {
            const videoPlayer = document.getElementById('videoPlayer');
            if (videoPlayer) {
                videoPlayer.play();
            }
        }

        function pauseVideo() {
            const videoPlayer = document.getElementById('videoPlayer');
            if (videoPlayer) {
                videoPlayer.pause();
            }
        }

        function seekVideo(seconds) {
            const videoPlayer = document.getElementById('videoPlayer');
            if (videoPlayer) {
                const newTime = Math.max(0, Math.min(videoDuration, currentTime + seconds));
                videoPlayer.currentTime = newTime;
                currentTime = newTime;
                updateTimeDisplay();
                updateTimelineProgress();
            }
        }

        function seekToTime(time) {
            const videoPlayer = document.getElementById('videoPlayer');
            if (videoPlayer) {
                videoPlayer.currentTime = time;
                currentTime = time;
                updateTimeDisplay();
                updateTimelineProgress();
            }
        }

        // æ—¶é—´è½´ç‚¹å‡»
        function handleTimelineClick(event) {
            if (videoDuration > 0) {
                const timeline = event.currentTarget;
                const rect = timeline.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const percentage = clickX / rect.width;
                const newTime = percentage * videoDuration;

                seekToTime(newTime);
            }
        }

        // æ ‡è®°ç®¡ç†
        function addMarker() {
            const marker = {
                id: markerIdCounter++,
                time: currentTime,
                title: `æ ‡è®° ${markerIdCounter - 1}`
            };
            markers.push(marker);
            selectedMarkerId = marker.id;
            updateMarkers();
            updateMarkerList();
            updateDebugInfo();
            addTestResult(`æ·»åŠ æ ‡è®°: ${formatTime(marker.time)}`, 'info');
        }

        function removeMarker() {
            if (selectedMarkerId) {
                const index = markers.findIndex(m => m.id === selectedMarkerId);
                if (index > -1) {
                    markers.splice(index, 1);
                    selectedMarkerId = '';
                    updateMarkers();
                    updateMarkerList();
                    updateDebugInfo();
                    addTestResult('æ ‡è®°å·²åˆ é™¤', 'info');
                }
            }
        }

        // é€‰é¡¹å¡åˆ‡æ¢
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰é€‰é¡¹å¡å†…å®¹
            const tabs = ['transcription', 'face', 'pip', 'recommendation', 'compatibility'];
            tabs.forEach(tab => {
                document.getElementById(`tab-${tab}`).style.display = tab === tabName ? 'block' : 'none';
            });

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            activeTab = tabName;
            addTestResult(`åˆ‡æ¢åˆ°é€‰é¡¹å¡: ${tabName}`, 'info');
        }

        // è¯­éŸ³è¯†åˆ«åŠŸèƒ½
        function startSpeechRecognition() {
            const speechBtn = document.getElementById('speechBtn');
            const speechStopBtn = document.getElementById('speechStopBtn');
            const speechResult = document.getElementById('speechResult');
            const speechStatus = document.getElementById('speechStatus');

            // æ£€æŸ¥ç¯å¢ƒ
            const isHttps = location.protocol === 'https:';
            const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            const isFileProtocol = location.protocol === 'file:';

            if (isFileProtocol) {
                speechStatus.innerHTML = 'âš ï¸ <span style="color: #ffeb3b;">æ–‡ä»¶åè®®ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨HTTP/HTTPSæœåŠ¡å™¨</span>';
                speechResult.innerHTML = '<strong>è§£å†³æ–¹æ¡ˆ:</strong><br>1. ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨è¿è¡Œ<br>2. æˆ–ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥åŠŸèƒ½<br>3. éƒ¨ç½²åˆ°HTTPSç½‘ç«™';
                addTestResult('âš ï¸ æ–‡ä»¶åè®®ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨HTTPæœåŠ¡å™¨', 'warning');
                return;
            }

            if (!isHttps && !isLocalhost) {
                speechStatus.innerHTML = 'âš ï¸ <span style="color: #ffeb3b;">å»ºè®®ä½¿ç”¨HTTPSç¯å¢ƒä»¥è·å¾—æ›´å¥½æ”¯æŒ</span>';
            } else {
                speechStatus.innerHTML = 'âœ… <span style="color: #4caf50;">ç¯å¢ƒæ£€æŸ¥é€šè¿‡</span>';
            }

            try {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    speechStatus.innerHTML = 'âŒ <span style="color: #f44336;">æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«</span>';
                    speechResult.innerHTML = '<strong>ä¸æ”¯æŒçš„æµè§ˆå™¨</strong><br>å»ºè®®ä½¿ç”¨ Chromeã€Edge æˆ– Safari';
                    addTestResult('âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«', 'error');
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();

                // é…ç½®å‚æ•°
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'zh-CN';
                recognition.interimResults = true;

                recognition.onstart = () => {
                    isRecording = true;
                    speechText = '';
                    speechStatus.innerHTML = 'ğŸ¤ <span style="color: #4caf50;">æ­£åœ¨å½•éŸ³ï¼Œè¯·è¯´è¯...</span>';
                    speechResult.innerHTML = '<em>å‡†å¤‡ä¸­ï¼Œè¯·å¼€å§‹è¯´è¯...</em>';
                    speechBtn.style.display = 'none';
                    speechStopBtn.style.display = 'inline-block';
                    addTestResult('ğŸ¤ è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨', 'info');
                };

                recognition.onresult = (event) => {
                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    if (finalTranscript.trim()) {
                        speechText = finalTranscript.trim();
                        speechStatus.innerHTML = 'âœ… <span style="color: #4caf50;">è¯†åˆ«æˆåŠŸ</span>';
                        speechResult.innerHTML = `<strong>ğŸ“ è½¬å½•ç»“æœ:</strong><br><span style="background: rgba(255,255,255,0.3); padding: 4px; border-radius: 2px;">${speechText}</span>`;
                        addTestResult(`âœ… è¯­éŸ³è¯†åˆ«å®Œæˆ: "${speechText}"`, 'success');
                    } else if (interimTranscript.trim()) {
                        speechStatus.innerHTML = 'ğŸ¤ <span style="color: #ff9800;">è¯†åˆ«ä¸­...</span>';
                        speechResult.innerHTML = `<em>æ­£åœ¨è¯†åˆ«: "${interimTranscript}"</em>`;
                    }
                };

                recognition.onerror = (event) => {
                    let errorMessage = '';
                    let suggestion = '';
                    let solution = '';

                    switch (event.error) {
                        case 'network':
                            errorMessage = 'ç½‘ç»œè¿æ¥é”™è¯¯';
                            suggestion = 'Web Speech APIéœ€è¦å®‰å…¨ç¯å¢ƒ';
                            solution = 'è§£å†³æ–¹æ¡ˆï¼š<br>1. ä½¿ç”¨HTTPSç½‘ç«™<br>2. ä½¿ç”¨localhostç¯å¢ƒ<br>3. æˆ–ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥åŠŸèƒ½';
                            break;
                        case 'not-allowed':
                            errorMessage = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»';
                            suggestion = 'æµè§ˆå™¨éœ€è¦éº¦å…‹é£è®¿é—®æƒé™';
                            solution = 'è§£å†³æ–¹æ¡ˆï¼š<br>1. ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„éº¦å…‹é£å›¾æ ‡<br>2. é€‰æ‹©"å…è®¸"<br>3. åˆ·æ–°é¡µé¢é‡æ–°å°è¯•';
                            break;
                        case 'no-speech':
                            errorMessage = 'æœªæ£€æµ‹åˆ°è¯­éŸ³';
                            suggestion = 'è¯·é è¿‘éº¦å…‹é£å¤§å£°è¯´è¯';
                            solution = 'æç¤ºï¼š<br>1. æ£€æŸ¥éº¦å…‹é£æ˜¯å¦æ’å¥½<br>2. ç¡®è®¤éº¦å…‹é£éŸ³é‡<br>3. å°è¯•ä¸åŒçš„æµè§ˆå™¨';
                            break;
                        case 'aborted':
                            errorMessage = 'è¯­éŸ³è¯†åˆ«è¢«ä¸­æ–­';
                            suggestion = 'å½•éŸ³è¿‡ç¨‹è¢«æ„å¤–ä¸­æ–­';
                            solution = 'è¯·é‡æ–°ç‚¹å‡»"å¼€å§‹å½•éŸ³"';
                            break;
                        case 'audio-capture':
                            errorMessage = 'éº¦å…‹é£è®¿é—®å¤±è´¥';
                            suggestion = 'æ— æ³•è®¿é—®éº¦å…‹é£è®¾å¤‡';
                            solution = 'æ£€æŸ¥ï¼š<br>1. éº¦å…‹é£æ˜¯å¦è¢«å…¶ä»–åº”ç”¨å ç”¨<br>2. ç³»ç»Ÿéšç§è®¾ç½®<br>3. éº¦å…‹é£ç¡¬ä»¶è¿æ¥';
                            break;
                        case 'service-not-allowed':
                            errorMessage = 'è¯­éŸ³æœåŠ¡ä¸å¯ç”¨';
                            suggestion = 'æµè§ˆå™¨è¯­éŸ³æœåŠ¡è¢«ç¦ç”¨';
                            solution = 'å°è¯•ï¼š<br>1. æ›´æ¢æµè§ˆå™¨<br>2. æ£€æŸ¥æµè§ˆå™¨è®¾ç½®<br>3. ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥';
                            break;
                        default:
                            errorMessage = `æœªçŸ¥é”™è¯¯: ${event.error}`;
                            suggestion = 'è¯·é‡è¯•æˆ–ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥';
                            solution = 'å¤‡é€‰æ–¹æ¡ˆï¼š<br>â€¢ ä½¿ç”¨ä¸‹æ–¹çš„æ‰‹åŠ¨è¾“å…¥åŠŸèƒ½<br>â€¢ å°è¯•ä¸åŒçš„æµè§ˆå™¨';
                    }

                    speechStatus.innerHTML = `âŒ <span style="color: #f44336;">${errorMessage}</span>`;
                    speechResult.innerHTML = `<div style="background: rgba(244, 67, 54, 0.1); padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                        <strong>ğŸ” é—®é¢˜:</strong> ${suggestion}<br>
                        <strong>ğŸ’¡ ${solution}</strong>
                    </div>`;

                    isRecording = false;
                    speechBtn.style.display = 'inline-block';
                    speechStopBtn.style.display = 'none';

                    addTestResult(`âŒ è¯­éŸ³è¯†åˆ«é”™è¯¯: ${errorMessage}`, 'error');

                    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œæ˜¾ç¤ºç¯å¢ƒæç¤º
                    if (event.error === 'network') {
                        const envNotice = document.getElementById('envNotice');
                        envNotice.innerHTML = '<strong>ğŸš¨ é‡è¦æç¤º:</strong> è¯­éŸ³è¯†åˆ«éœ€è¦HTTPSæˆ–localhostç¯å¢ƒã€‚<br>å½“å‰é¡µé¢ä½¿ç”¨HTTPï¼Œå¯èƒ½å¯¼è‡´ç½‘ç»œé”™è¯¯ã€‚<br><strong>å»ºè®®è§£å†³æ–¹æ¡ˆ:</strong><br>1. éƒ¨ç½²åˆ°HTTPSç½‘ç«™<br>2. ä½¿ç”¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨<br>3. æˆ–ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥åŠŸèƒ½';
                        envNotice.style.display = 'block';
                        envNotice.style.background = 'linear-gradient(135deg, #ff6b6b, #4ecdc4)';
                    }
                };

                recognition.onend = () => {
                    isRecording = false;
                    speechBtn.style.display = 'inline-block';
                    speechStopBtn.style.display = 'none';

                    if (!speechText) {
                        speechStatus.innerHTML = 'â¹ï¸ <span style="color: #9e9e9e;">å½•éŸ³å·²ç»“æŸ</span>';
                        speechResult.innerHTML = '<em>æœªæ£€æµ‹åˆ°è¯­éŸ³å†…å®¹</em>';
                    }

                    addTestResult('è¯­éŸ³è¯†åˆ«å·²ç»“æŸ', 'info');
                };

                recognition.start();

            } catch (error) {
                speechStatus.innerHTML = `âŒ <span style="color: #f44336;">å¯åŠ¨å¤±è´¥</span>`;
                speechResult.innerHTML = `<strong>é”™è¯¯è¯¦æƒ…:</strong> ${error.message}<br><strong>ğŸ”„ å¤‡é€‰æ–¹æ¡ˆ:</strong> ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥åŠŸèƒ½`;
                addTestResult(`âŒ å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function stopSpeechRecognition() {
            if (recognition && isRecording) {
                recognition.stop();
                addTestResult('ğŸ”„ ç”¨æˆ·ä¸»åŠ¨åœæ­¢è¯­éŸ³è¯†åˆ«', 'info');
            }
        }

        function saveManualTranscript() {
            const manualText = document.getElementById('manualTranscript').value.trim();
            if (manualText) {
                speechText = manualText;
                document.getElementById('speechResult').innerHTML = `<strong>ğŸ“ æ‰‹åŠ¨è¾“å…¥ç»“æœ:</strong><br><span style="background: rgba(255,255,255,0.3); padding: 4px; border-radius: 2px;">${speechText}</span>`;
                document.getElementById('speechStatus').innerHTML = 'âœ… <span style="color: #4caf50;">æ‰‹åŠ¨è¾“å…¥å·²ä¿å­˜</span>';
                addTestResult(`âœ… æ‰‹åŠ¨è¾“å…¥ä¿å­˜: "${speechText}"`, 'success');
            } else {
                addTestResult('âš ï¸ è¯·è¾“å…¥æ–‡å­—å†…å®¹', 'warning');
            }
        }

        // æµ‹è¯•éº¦å…‹é£æƒé™
        function testMicrophonePermission() {
            const micTestBtn = document.getElementById('micTestBtn');
            const micTestResult = document.getElementById('micTestResult');

            micTestBtn.textContent = 'â³ æµ‹è¯•ä¸­...';
            micTestBtn.disabled = true;
            micTestResult.innerHTML = '<span style="color: #ff9800;">æ­£åœ¨æµ‹è¯•éº¦å…‹é£æƒé™...</span>';

            // æ£€æŸ¥getUserMediaæ”¯æŒ
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                micTestResult.innerHTML = '<span style="color: #f44336;">âŒ æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£è®¿é—®API</span>';
                micTestBtn.textContent = 'ğŸ” æµ‹è¯•éº¦å…‹é£æƒé™';
                micTestBtn.disabled = false;
                return;
            }

            // è¯·æ±‚éº¦å…‹é£æƒé™
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    // æˆåŠŸè·å–æƒé™
                    micTestResult.innerHTML = '<span style="color: #4caf50;">âœ… éº¦å…‹é£æƒé™æ­£å¸¸ï¼Œè¯­éŸ³è¯†åˆ«åº”è¯¥å¯ä»¥å·¥ä½œ</span>';
                    addTestResult('âœ… éº¦å…‹é£æƒé™æµ‹è¯•é€šè¿‡', 'success');

                    // ç«‹å³åœæ­¢æµ
                    stream.getTracks().forEach(track => track.stop());
                })
                .catch(error => {
                    let errorMsg = '';
                    let suggestion = '';

                    switch (error.name) {
                        case 'NotAllowedError':
                            errorMsg = 'âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»';
                            suggestion = 'è¯·ç‚¹å‡»æµè§ˆå™¨åœ°å€æ å·¦ä¾§çš„éº¦å…‹é£å›¾æ ‡ï¼Œé€‰æ‹©"å…è®¸"';
                            break;
                        case 'NotFoundError':
                            errorMsg = 'âŒ æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡';
                            suggestion = 'è¯·æ£€æŸ¥éº¦å…‹é£æ˜¯å¦æ’å¥½ï¼Œæˆ–ä½¿ç”¨ç³»ç»Ÿå†…ç½®éº¦å…‹é£';
                            break;
                        case 'NotReadableError':
                            errorMsg = 'âŒ éº¦å…‹é£è¢«å…¶ä»–åº”ç”¨å ç”¨';
                            suggestion = 'è¯·å…³é—­å…¶ä»–ä½¿ç”¨éº¦å…‹é£çš„åº”ç”¨';
                            break;
                        case 'OverconstrainedError':
                            errorMsg = 'âŒ éº¦å…‹é£é…ç½®é”™è¯¯';
                            suggestion = 'è¯·æ£€æŸ¥éº¦å…‹é£è®¾ç½®';
                            break;
                        case 'SecurityError':
                            errorMsg = 'âŒ éœ€è¦å®‰å…¨ç¯å¢ƒ';
                            suggestion = 'è¯·ä½¿ç”¨HTTPSç½‘ç«™æˆ–localhost';
                            break;
                        default:
                            errorMsg = `âŒ éº¦å…‹é£é”™è¯¯: ${error.name}`;
                            suggestion = 'è¯·æ£€æŸ¥éº¦å…‹é£è¿æ¥å’Œæƒé™è®¾ç½®';
                    }

                    micTestResult.innerHTML = `${errorMsg}<br><small>ğŸ’¡ ${suggestion}</small>`;
                    addTestResult(`âŒ éº¦å…‹é£æƒé™æµ‹è¯•å¤±è´¥: ${error.name}`, 'error');
                })
                .finally(() => {
                    micTestBtn.textContent = 'ğŸ” æµ‹è¯•éº¦å…‹é£æƒé™';
                    micTestBtn.disabled = false;
                });
        }

        // äººè„¸è·Ÿè¸ªåŠŸèƒ½
        function initializeFaceTracking() {
            const faceBtn = document.getElementById('faceBtn');
            const faceResult = document.getElementById('faceResult');

            faceBtn.textContent = 'â³ åˆå§‹åŒ–ä¸­...';
            faceBtn.disabled = true;

            setTimeout(() => {
                faceTrackingInitialized = true;
                detectedFaces = Math.floor(Math.random() * 3) + 1;
                faceResult.textContent = `âœ… äººè„¸è·Ÿè¸ªå·²å¯ç”¨ï¼Œæ£€æµ‹åˆ° ${detectedFaces} ä¸ªäººè„¸`;
                faceBtn.textContent = 'âœ… å·²åˆå§‹åŒ–';
                addTestResult(`âœ… äººè„¸è·Ÿè¸ªåˆå§‹åŒ–å®Œæˆï¼Œæ£€æµ‹åˆ° ${detectedFaces} ä¸ªäººè„¸`, 'success');
            }, 2000);
        }

        // ç”»ä¸­ç”»æ•ˆæœ
        function applyPictureInPicture() {
            const pipBtn = document.getElementById('pipBtn');
            const pipResult = document.getElementById('pipResult');

            if (!currentVideoFile) {
                addTestResult('âŒ è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶', 'error');
                pipResult.textContent = 'è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶';
                return;
            }

            pipApplied = true;
            pipResult.textContent = 'âœ… ç”»ä¸­ç”»æ•ˆæœå·²åº”ç”¨';
            pipBtn.textContent = 'âœ… å·²åº”ç”¨';
            addTestResult('âœ… ç”»ä¸­ç”»æ•ˆæœå·²åº”ç”¨', 'success');
        }

        // æ™ºèƒ½æ¨è
        function generateRecommendations() {
            const recBtn = document.getElementById('recBtn');
            const recResult = document.getElementById('recResult');

            if (!currentVideoFile) {
                addTestResult('âŒ è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶', 'error');
                recResult.textContent = 'è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶';
                return;
            }

            recBtn.textContent = 'â³ ç”Ÿæˆä¸­...';
            recBtn.disabled = true;

            setTimeout(() => {
                const mockRecommendations = [
                    'å»ºè®®åœ¨ç¬¬15ç§’æ·»åŠ æ ‡é¢˜å¹»ç¯ç‰‡',
                    'æ£€æµ‹åˆ°å›¾è¡¨éœ€æ±‚ï¼Œå»ºè®®æ·»åŠ æŸ±çŠ¶å›¾',
                    'è§†é¢‘å†…å®¹é€‚åˆåˆ¶ä½œ3-5é¡µPPT'
                ];

                recommendations = mockRecommendations;
                recResult.innerHTML = '<strong>æ¨èç»“æœ:</strong><br>' +
                    mockRecommendations.map(rec => `â€¢ ${rec}`).join('<br>');
                recBtn.textContent = 'âœ… å·²ç”Ÿæˆ';
                recBtn.disabled = false;
                addTestResult(`âœ… ç”Ÿæˆ ${mockRecommendations.length} æ¡æ™ºèƒ½æ¨è`, 'success');
            }, 1500);
        }

        // å…¼å®¹æ€§æ£€æŸ¥
        function checkCompatibility() {
            const compatResult = document.getElementById('compatResult');

            const checks = [
                { feature: 'File API', status: typeof File !== 'undefined' },
                { feature: 'Video Element', status: !!document.createElement('video').canPlayType },
                { feature: 'Canvas 2D', status: !!document.createElement('canvas').getContext('2d') },
                { feature: 'LocalStorage', status: typeof localStorage !== 'undefined' },
                { feature: 'Web Speech API', status: ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) },
                { feature: 'WebGL', status: !!document.createElement('canvas').getContext('webgl') },
                { feature: 'WebAssembly', status: typeof WebAssembly !== 'undefined' }
            ];

            const results = checks.map(check => {
                const icon = check.status ? 'âœ…' : 'âŒ';
                const statusText = check.status ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ';
                return `${icon} ${check.feature}: ${statusText}`;
            });

            compatResult.innerHTML = '<strong>æ£€æŸ¥ç»“æœ:</strong><br>' +
                results.join('<br>');

            addTestResult(`âœ… å…¼å®¹æ€§æ£€æŸ¥å®Œæˆï¼Œå…±æ£€æŸ¥ ${checks.length} é¡¹åŠŸèƒ½`, 'success');
        }

        // é¡µé¢åˆå§‹åŒ–
        window.addEventListener('load', () => {
            addTestResult('âœ… VidSlide AI ç®€åŒ–ç‰ˆæœ¬åŠ è½½æˆåŠŸ', 'success');
            addTestResult('ğŸ‰ æ‰€æœ‰åŸºç¡€åŠŸèƒ½ç°å·²å¯ç”¨ï¼', 'success');

            // æ£€æŸ¥è¿è¡Œç¯å¢ƒ
            const isHttps = location.protocol === 'https:';
            const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            const isFileProtocol = location.protocol === 'file:';

            const envNotice = document.getElementById('envNotice');

            if (isFileProtocol) {
                envNotice.innerHTML = '<strong>ğŸ¯ è¯­éŸ³è¯†åˆ«æç¤º:</strong> å½“å‰ä½¿ç”¨æ–‡ä»¶åè®®ï¼Œè¯­éŸ³è¯†åˆ«åŠŸèƒ½å—é™ã€‚<br>å»ºè®®: <code style="background: rgba(0,0,0,0.2); padding: 2px 4px; border-radius: 2px;">python3 -m http.server 8080</code> ç„¶åè®¿é—® <code style="background: rgba(0,0,0,0.2); padding: 2px 4px; border-radius: 2px;">http://localhost:8080/vidslide-simple.html</code>';
                envNotice.style.display = 'block';
                addTestResult('âš ï¸ æ£€æµ‹åˆ°æ–‡ä»¶åè®®(file://)ï¼Œè¯­éŸ³è¯†åˆ«åŠŸèƒ½å—é™', 'warning');
                document.getElementById('speechStatus').innerHTML = 'âš ï¸ <span style="color: #ffeb3b;">æ–‡ä»¶åè®®ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«</span>';
            } else if (isHttps) {
                envNotice.style.display = 'none';
                addTestResult('âœ… HTTPSç¯å¢ƒï¼Œè¯­éŸ³è¯†åˆ«å®Œå…¨æ”¯æŒ', 'success');
                document.getElementById('speechStatus').innerHTML = 'âœ… <span style="color: #4caf50;">HTTPSç¯å¢ƒï¼Œå®Œå…¨æ”¯æŒè¯­éŸ³è¯†åˆ«</span>';
            } else if (isLocalhost) {
                envNotice.innerHTML = '<strong>ğŸ’¡ æç¤º:</strong> ä½¿ç”¨localhostç¯å¢ƒï¼Œè¯­éŸ³è¯†åˆ«éœ€è¦ç”¨æˆ·å…è®¸éº¦å…‹é£æƒé™ã€‚å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·ä½¿ç”¨HTTPSç½‘ç«™æˆ–æ‰‹åŠ¨è¾“å…¥åŠŸèƒ½ã€‚';
                envNotice.style.display = 'block';
                addTestResult('âœ… localhostç¯å¢ƒï¼Œè¯­éŸ³è¯†åˆ«åŸºæœ¬æ”¯æŒ', 'success');
                document.getElementById('speechStatus').innerHTML = 'âœ… <span style="color: #4caf50;">localhostç¯å¢ƒï¼Œæ”¯æŒè¯­éŸ³è¯†åˆ«</span>';
            } else {
                envNotice.innerHTML = '<strong>âš ï¸ ç¯å¢ƒè­¦å‘Š:</strong> å½“å‰ä½¿ç”¨HTTPç¯å¢ƒï¼Œè¯­éŸ³è¯†åˆ«å¯èƒ½ä¸ç¨³å®šã€‚å»ºè®®ï¼š<br>1. ä½¿ç”¨HTTPSç½‘ç«™<br>2. ä½¿ç”¨localhost<br>3. æˆ–ä½¿ç”¨ä¸‹æ–¹æ‰‹åŠ¨è¾“å…¥åŠŸèƒ½';
                envNotice.style.display = 'block';
                addTestResult('âš ï¸ HTTPç¯å¢ƒï¼Œè¯­éŸ³è¯†åˆ«å¯èƒ½å—é™', 'warning');
                document.getElementById('speechStatus').innerHTML = 'âš ï¸ <span style="color: #ff9800;">HTTPç¯å¢ƒï¼Œè¯­éŸ³è¯†åˆ«å¯èƒ½å—é™</span>';
            }

            // è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
            setTimeout(() => {
                // æ£€æŸ¥æµè§ˆå™¨åŠŸèƒ½
                if (window.File && window.FileReader && window.FileList && window.Blob) {
                    addTestResult('âœ… File APIæ”¯æŒæ­£å¸¸', 'success');
                } else {
                    addTestResult('âŒ File APIä¸æ”¯æŒ', 'error');
                }

                // æ£€æŸ¥è§†é¢‘æ”¯æŒ
                const video = document.createElement('video');
                const canPlayTypes = [
                    'video/mp4; codecs="avc1.42E01E"',
                    'video/webm; codecs="vp8, vorbis"',
                    'video/ogg; codecs="theora"'
                ];

                let supportedTypes = [];
                canPlayTypes.forEach(type => {
                    if (video.canPlayType(type) !== '') {
                        supportedTypes.push(type.split(';')[0]);
                    }
                });

                if (supportedTypes.length > 0) {
                    addTestResult(`âœ… è§†é¢‘æ”¯æŒ: ${supportedTypes.join(', ')}`, 'success');
                } else {
                    addTestResult('âŒ æµè§ˆå™¨ä¸æ”¯æŒå¸¸è§è§†é¢‘æ ¼å¼', 'error');
                }

                // æ£€æŸ¥è¯­éŸ³è¯†åˆ«æ”¯æŒ
                const speechSupported = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
                if (speechSupported) {
                    addTestResult('âœ… è¯­éŸ³è¯†åˆ«APIå¯ç”¨', 'success');
                } else {
                    addTestResult('âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«', 'warning');
                }

                // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
                try {
                    const testKey = 'vidslide-test';
                    localStorage.setItem(testKey, 'works');
                    const retrieved = localStorage.getItem(testKey);
                    if (retrieved === 'works') {
                        addTestResult('âœ… æœ¬åœ°å­˜å‚¨åŠŸèƒ½æ­£å¸¸', 'success');
                        localStorage.removeItem(testKey);
                    } else {
                        addTestResult('âŒ æœ¬åœ°å­˜å‚¨æµ‹è¯•å¤±è´¥', 'error');
                    }
                } catch (error) {
                    addTestResult(`âŒ æœ¬åœ°å­˜å‚¨å¤±è´¥: ${error.message}`, 'error');
                }

                updateDebugInfo();
            }, 100);
        });

        // é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            addTestResult(`âŒ é¡µé¢é”™è¯¯: ${event.error.message}`, 'error');
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (videoSrc) {
                URL.revokeObjectURL(videoSrc);
            }
        });
    </script>
</body>
</html>
