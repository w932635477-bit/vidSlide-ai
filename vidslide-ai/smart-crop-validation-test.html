<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è£å‰ªåŠŸèƒ½éªŒè¯æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
        }

        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .test-section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        button.success {
            background: #27ae60;
        }

        button.error {
            background: #e74c3c;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status.loading {
            background: #f39c12;
            color: white;
        }

        .status.success {
            background: #27ae60;
            color: white;
        }

        .status.error {
            background: #e74c3c;
            color: white;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background: #fafafa;
        }

        .result-item h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .result-item .metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .result-item .metric span:first-child {
            font-weight: bold;
        }

        .image-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .image-container {
            text-align: center;
        }

        .image-container img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .image-container .label {
            margin-top: 10px;
            font-weight: bold;
            color: #2c3e50;
        }

        .crop-overlay {
            position: relative;
            display: inline-block;
        }

        .crop-rect {
            position: absolute;
            border: 2px solid #e74c3c;
            background: rgba(231, 76, 60, 0.3);
            pointer-events: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #3498db;
            transition: width 0.3s;
        }

        .console-output {
            background: #2c3e50;
            color: #ecf0f1;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }

        .console-output .log-entry {
            margin: 2px 0;
        }

        .console-output .error {
            color: #e74c3c;
        }

        .console-output .success {
            color: #27ae60;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .summary-card h3 {
            margin-bottom: 15px;
        }

        .score-display {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }

        .recommendations {
            margin-top: 20px;
        }

        .recommendations ul {
            list-style: none;
            padding: 0;
        }

        .recommendations li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .recommendations li:before {
            content: "âœ“";
            margin-right: 10px;
            color: #27ae60;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§  æ™ºèƒ½è£å‰ªåŠŸèƒ½éªŒè¯æµ‹è¯•</h1>
            <p>æµ‹è¯•OpenCV.jsé›†æˆçš„æ™ºèƒ½è£å‰ªç®—æ³•ï¼ŒåŒ…æ‹¬å‡†ç¡®æ€§ã€æ€§èƒ½å’Œå†…å­˜ç®¡ç†</p>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ éªŒè¯æ§åˆ¶é¢æ¿</h2>
            <div class="test-controls">
                <button id="start-validation" onclick="startValidation()">å¼€å§‹å…¨é¢éªŒè¯</button>
                <button id="test-opencv" onclick="testOpenCV()">æµ‹è¯•OpenCVé›†æˆ</button>
                <button id="test-accuracy" onclick="testAccuracy()">æµ‹è¯•ç®—æ³•å‡†ç¡®æ€§</button>
                <button id="test-performance" onclick="testPerformance()">æµ‹è¯•æ€§èƒ½åŸºå‡†</button>
                <button id="test-memory" onclick="testMemory()">æµ‹è¯•å†…å­˜ç®¡ç†</button>
                <button id="clear-console" onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
            </div>

            <div id="overall-status" class="status" style="display: none;">
                éªŒè¯çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
            </div>

            <div id="progress-container" style="display: none;">
                <div>éªŒè¯è¿›åº¦:</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š éªŒè¯ç»“æœ</h2>
            <div id="results-container">
                <p>è¯·ç‚¹å‡»"å¼€å§‹å…¨é¢éªŒè¯"æ¥è¿è¡Œæµ‹è¯•</p>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ–¼ï¸ è£å‰ªæ•ˆæœæ¼”ç¤º</h2>
            <div id="demo-container">
                <p>é€‰æ‹©ä¸€å¼ æµ‹è¯•å›¾ç‰‡è¿›è¡Œæ™ºèƒ½è£å‰ªæ¼”ç¤º</p>
                <div class="test-controls">
                    <button onclick="demoCrop('centered')">å±…ä¸­ä¸»ä½“</button>
                    <button onclick="demoCrop('offset')">åç§»ä¸»ä½“</button>
                    <button onclick="demoCrop('multiple')">å¤šä¸»ä½“</button>
                    <button onclick="demoCrop('complex')">å¤æ‚èƒŒæ™¯</button>
                    <button onclick="demoCrop('contrast')">ä½å¯¹æ¯”åº¦</button>
                </div>
                <div id="demo-results"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ’» æ§åˆ¶å°è¾“å‡º</h2>
            <div class="console-output" id="console-output">
                ç­‰å¾…éªŒè¯å¼€å§‹...
            </div>
        </div>
    </div>

    <script type="module">
        import { validateSmartCrop, getSmartCropValidationSummary } from './smart-crop-validation.js'

        let currentValidation = null
        let consoleElement = document.getElementById('console-output')

        // æ§åˆ¶å°æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const entry = document.createElement('div')
            entry.className = `log-entry ${type}`
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`
            consoleElement.appendChild(entry)
            consoleElement.scrollTop = consoleElement.scrollHeight
            console.log(message)
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent) {
            const progressFill = document.getElementById('progress-fill')
            const progressContainer = document.getElementById('progress-container')

            progressContainer.style.display = 'block'
            progressFill.style.width = `${percent}%`
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, type = 'loading') {
            const statusElement = document.getElementById('overall-status')
            statusElement.textContent = message
            statusElement.className = `status ${type}`
            statusElement.style.display = 'block'
        }

        // æ˜¾ç¤ºéªŒè¯ç»“æœ
        function displayResults(summary) {
            const container = document.getElementById('results-container')
            const { overallScore, results, recommendations, nextSteps } = summary

            let html = `
                <div class="summary-card">
                    <h3>ğŸ† éªŒè¯å®Œæˆæ€»ç»“</h3>
                    <div class="score-display">${overallScore}/100</div>
                    <p style="text-align: center; margin-bottom: 20px;">
                        ${overallScore >= 80 ? 'ä¼˜ç§€' : overallScore >= 60 ? 'è‰¯å¥½' : 'éœ€è¦æ”¹è¿›'}
                    </p>
                </div>

                <div class="results-grid">
            `

            results.forEach(result => {
                const icon = result.success ? 'âœ…' : 'âŒ'
                const statusClass = result.success ? 'success' : 'error'

                html += `
                    <div class="result-item">
                        <h3>${icon} ${result.name}</h3>
                        <div class="metric">
                            <span>çŠ¶æ€:</span>
                            <span class="${statusClass}">${result.success ? 'é€šè¿‡' : 'å¤±è´¥'}</span>
                        </div>
                    </div>
                `
            })

            html += `
                </div>

                <div class="recommendations">
                    <h3>ğŸ’¡ å®æ–½å»ºè®®</h3>
                    <ul>
                        ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>

                    <h3 style="margin-top: 20px;">ğŸš€ åç»­æ­¥éª¤</h3>
                    <ul>
                        ${nextSteps.map(step => `<li>${step}</li>`).join('')}
                    </ul>
                </div>
            `

            container.innerHTML = html
        }

        // å¼€å§‹å…¨é¢éªŒè¯
        window.startValidation = async function() {
            if (currentValidation) return

            try {
                updateStatus('æ­£åœ¨åˆå§‹åŒ–éªŒè¯å™¨...', 'loading')
                updateProgress(0)

                log('ğŸš€ å¼€å§‹æ™ºèƒ½è£å‰ªåŠŸèƒ½å…¨é¢éªŒè¯', 'success')

                const validator = await validateSmartCrop()
                currentValidation = validator

                updateProgress(100)
                updateStatus('éªŒè¯å®Œæˆï¼', 'success')

                displayResults(validator)

                log(`ğŸ† éªŒè¯å®Œæˆ - æ€»ä½“å¾—åˆ†: ${validator.overallScore}/100`, 'success')

            } catch (error) {
                updateStatus('éªŒè¯å¤±è´¥: ' + error.message, 'error')
                log('âŒ éªŒè¯å¤±è´¥: ' + error.message, 'error')
            }
        }

        // æµ‹è¯•OpenCVé›†æˆ
        window.testOpenCV = async function() {
            try {
                updateStatus('æµ‹è¯•OpenCV.jsé›†æˆ...', 'loading')

                const summary = getSmartCropValidationSummary()
                if (!summary.opencvIntegration.success) {
                    const validator = await import('./smart-crop-validation.js').then(m => m.getSmartCropValidator())
                    await validator.validateOpenCVIntegration()
                }

                const result = getSmartCropValidationSummary().opencvIntegration
                updateStatus(
                    result.success ? 'OpenCVé›†æˆæˆåŠŸ' : 'OpenCVé›†æˆå¤±è´¥',
                    result.success ? 'success' : 'error'
                )

                log(`OpenCVé›†æˆæµ‹è¯•: ${result.success ? 'é€šè¿‡' : 'å¤±è´¥'}`)

            } catch (error) {
                updateStatus('OpenCVæµ‹è¯•å¤±è´¥', 'error')
                log('OpenCVæµ‹è¯•é”™è¯¯: ' + error.message, 'error')
            }
        }

        // æµ‹è¯•ç®—æ³•å‡†ç¡®æ€§
        window.testAccuracy = async function() {
            try {
                updateStatus('æµ‹è¯•ç®—æ³•å‡†ç¡®æ€§...', 'loading')

                const validator = await import('./smart-crop-validation.js').then(m => m.getSmartCropValidator())
                const success = await validator.validateAlgorithmAccuracy()

                updateStatus(
                    success ? 'ç®—æ³•å‡†ç¡®æ€§æµ‹è¯•é€šè¿‡' : 'ç®—æ³•å‡†ç¡®æ€§æµ‹è¯•å¤±è´¥',
                    success ? 'success' : 'error'
                )

                log(`ç®—æ³•å‡†ç¡®æ€§æµ‹è¯•: ${success ? 'é€šè¿‡' : 'å¤±è´¥'}`)

            } catch (error) {
                updateStatus('å‡†ç¡®æ€§æµ‹è¯•å¤±è´¥', 'error')
                log('å‡†ç¡®æ€§æµ‹è¯•é”™è¯¯: ' + error.message, 'error')
            }
        }

        // æµ‹è¯•æ€§èƒ½åŸºå‡†
        window.testPerformance = async function() {
            try {
                updateStatus('æµ‹è¯•æ€§èƒ½åŸºå‡†...', 'loading')

                const validator = await import('./smart-crop-validation.js').then(m => m.getSmartCropValidator())
                const success = await validator.validatePerformanceBenchmark()

                updateStatus(
                    success ? 'æ€§èƒ½åŸºå‡†æµ‹è¯•é€šè¿‡' : 'æ€§èƒ½åŸºå‡†æµ‹è¯•å¤±è´¥',
                    success ? 'success' : 'error'
                )

                log(`æ€§èƒ½åŸºå‡†æµ‹è¯•: ${success ? 'é€šè¿‡' : 'å¤±è´¥'}`)

            } catch (error) {
                updateStatus('æ€§èƒ½æµ‹è¯•å¤±è´¥', 'error')
                log('æ€§èƒ½æµ‹è¯•é”™è¯¯: ' + error.message, 'error')
            }
        }

        // æµ‹è¯•å†…å­˜ç®¡ç†
        window.testMemory = async function() {
            try {
                updateStatus('æµ‹è¯•å†…å­˜ç®¡ç†...', 'loading')

                const validator = await import('./smart-crop-validation.js').then(m => m.getSmartCropValidator())
                const success = await validator.validateMemoryManagement()

                updateStatus(
                    success ? 'å†…å­˜ç®¡ç†æµ‹è¯•é€šè¿‡' : 'å†…å­˜ç®¡ç†æµ‹è¯•å¤±è´¥',
                    success ? 'success' : 'error'
                )

                log(`å†…å­˜ç®¡ç†æµ‹è¯•: ${success ? 'é€šè¿‡' : 'å¤±è´¥'}`)

            } catch (error) {
                updateStatus('å†…å­˜æµ‹è¯•å¤±è´¥', 'error')
                log('å†…å­˜æµ‹è¯•é”™è¯¯: ' + error.message, 'error')
            }
        }

        // æ¼”ç¤ºè£å‰ªæ•ˆæœ
        window.demoCrop = async function(type) {
            try {
                updateStatus(`æ¼”ç¤º${type}è£å‰ª...`, 'loading')

                const demoContainer = document.getElementById('demo-results')
                demoContainer.innerHTML = '<p>æ­£åœ¨ç”Ÿæˆæ¼”ç¤ºå›¾åƒ...</p>'

                // åˆ›å»ºæµ‹è¯•å›¾åƒ
                const canvas = document.createElement('canvas')
                const ctx = canvas.getContext('2d')
                canvas.width = 400
                canvas.height = 300

                // ç”Ÿæˆä¸åŒç±»å‹çš„æµ‹è¯•å›¾åƒ
                generateDemoImage(ctx, canvas.width, canvas.height, type)

                const image = new Image()
                image.src = canvas.toDataURL()
                image.style.maxWidth = '100%'

                await new Promise(resolve => image.onload = resolve)

                // å¯¼å…¥æ™ºèƒ½è£å‰ªæ¨¡å—
                const { smartCropImage } = await import('./src/utils/smartCrop.js')

                // æ‰§è¡Œæ™ºèƒ½è£å‰ª
                const result = await smartCropImage(image)

                if (result.success && result.cropRect) {
                    // æ˜¾ç¤ºåŸå§‹å›¾åƒå’Œè£å‰ªç»“æœ
                    const originalContainer = document.createElement('div')
                    originalContainer.className = 'image-container'
                    originalContainer.innerHTML = `
                        <div class="crop-overlay">
                            <img src="${image.src}" alt="åŸå§‹å›¾åƒ">
                            <div class="crop-rect" style="
                                left: ${result.cropRect.x}px;
                                top: ${result.cropRect.y}px;
                                width: ${result.cropRect.width}px;
                                height: ${result.cropRect.height}px;
                            "></div>
                        </div>
                        <div class="label">åŸå§‹å›¾åƒ (è£å‰ªåŒºåŸŸæ ‡å‡º)</div>
                    `

                    // åˆ›å»ºè£å‰ªåçš„å›¾åƒ
                    const croppedCanvas = document.createElement('canvas')
                    const croppedCtx = croppedCanvas.getContext('2d')
                    croppedCanvas.width = result.cropRect.width
                    croppedCanvas.height = result.cropRect.height

                    croppedCtx.drawImage(
                        image,
                        result.cropRect.x, result.cropRect.y,
                        result.cropRect.width, result.cropRect.height,
                        0, 0,
                        result.cropRect.width, result.cropRect.height
                    )

                    const croppedContainer = document.createElement('div')
                    croppedContainer.className = 'image-container'
                    croppedContainer.innerHTML = `
                        <img src="${croppedCanvas.toDataURL()}" alt="è£å‰ªç»“æœ">
                        <div class="label">è£å‰ªç»“æœ</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            ç½®ä¿¡åº¦: ${(result.confidence * 100).toFixed(1)}%<br>
                            å¤„ç†æ—¶é—´: ${result.processingTime}ms
                        </div>
                    `

                    demoContainer.innerHTML = ''
                    demoContainer.appendChild(originalContainer)
                    demoContainer.appendChild(croppedContainer)

                    updateStatus(`è£å‰ªæ¼”ç¤ºå®Œæˆ - ç½®ä¿¡åº¦: ${(result.confidence * 100).toFixed(1)}%`, 'success')
                    log(`è£å‰ªæ¼”ç¤ºå®Œæˆ: ${type}, ç½®ä¿¡åº¦ ${(result.confidence * 100).toFixed(1)}%`)

                } else {
                    demoContainer.innerHTML = '<p style="color: #e74c3c;">è£å‰ªå¤±è´¥</p>'
                    updateStatus('è£å‰ªæ¼”ç¤ºå¤±è´¥', 'error')
                }

            } catch (error) {
                updateStatus('è£å‰ªæ¼”ç¤ºå‡ºé”™', 'error')
                log('è£å‰ªæ¼”ç¤ºé”™è¯¯: ' + error.message, 'error')
            }
        }

        // ç”Ÿæˆæ¼”ç¤ºå›¾åƒ
        function generateDemoImage(ctx, width, height, type) {
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = '#f0f0f0'
            ctx.fillRect(0, 0, width, height)

            switch (type) {
                case 'centered':
                    // å±…ä¸­çŸ©å½¢ä¸»ä½“
                    ctx.fillStyle = '#333333'
                    ctx.fillRect(width * 0.25, height * 0.25, width * 0.5, height * 0.5)
                    break

                case 'offset':
                    // åç§»åœ†å½¢ä¸»ä½“
                    ctx.fillStyle = '#666666'
                    ctx.beginPath()
                    ctx.arc(width * 0.7, height * 0.6, width * 0.15, 0, 2 * Math.PI)
                    ctx.fill()
                    break

                case 'multiple':
                    // å¤šä¸ªä¸»ä½“
                    ctx.fillStyle = '#444444'
                    ctx.fillRect(width * 0.1, height * 0.1, width * 0.3, height * 0.3)
                    ctx.fillStyle = '#777777'
                    ctx.fillRect(width * 0.6, height * 0.5, width * 0.3, height * 0.2)
                    break

                case 'complex':
                    // å¤æ‚èƒŒæ™¯ + ä¸»ä½“
                    for (let i = 0; i < 20; i++) {
                        ctx.fillStyle = `hsl(${Math.random() * 360}, 30%, ${50 + Math.random() * 20}%)`
                        ctx.fillRect(
                            Math.random() * width,
                            Math.random() * height,
                            Math.random() * 30 + 10,
                            Math.random() * 30 + 10
                        )
                    }
                    ctx.fillStyle = '#000000'
                    ctx.fillRect(width * 0.3, height * 0.3, width * 0.4, height * 0.4)
                    break

                case 'contrast':
                    // ä½å¯¹æ¯”åº¦
                    ctx.fillStyle = '#e0e0e0'
                    ctx.fillRect(0, 0, width, height)
                    ctx.fillStyle = '#c0c0c0'
                    ctx.fillRect(width * 0.2, height * 0.2, width * 0.6, height * 0.6)
                    break
            }
        }

        // æ¸…ç©ºæ§åˆ¶å°
        window.clearConsole = function() {
            consoleElement.innerHTML = 'æ§åˆ¶å°å·²æ¸…ç©º...'
        }

        // é¡µé¢åŠ è½½å®Œæˆæç¤º
        log('æ™ºèƒ½è£å‰ªéªŒè¯æµ‹è¯•é¡µé¢å·²åŠ è½½å®Œæˆ', 'success')
        log('ç‚¹å‡»"å¼€å§‹å…¨é¢éªŒè¯"å¼€å§‹æµ‹è¯•', 'info')
    </script>
</body>
</html>