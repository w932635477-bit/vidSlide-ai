#!/bin/bash
# ğŸš€ è…¾è®¯äº‘ç§‘å­¦ä¸Šç½‘ä¸€é”®å¯åŠ¨è„šæœ¬
# ä½¿ç”¨æ–¹æ³•: proxy start|stop|status|test

# è·å–è„šæœ¬çš„å®é™…è·¯å¾„ï¼ˆè§£å†³ç¬¦å·é“¾æ¥é—®é¢˜ï¼‰
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"

show_help() {
    echo "ğŸš€ è…¾è®¯äº‘ç§‘å­¦ä¸Šç½‘ç®¡ç†è„šæœ¬"
    echo ""
    echo "ä½¿ç”¨æ–¹æ³•:"
    echo "  proxy start    å¯åŠ¨ä»£ç†æœåŠ¡"
    echo "  proxy stop     åœæ­¢ä»£ç†æœåŠ¡"
    echo "  proxy status   æŸ¥çœ‹ä»£ç†çŠ¶æ€"
    echo "  proxy test     æµ‹è¯•ç½‘ç»œè¿æ¥"
    echo "  proxy help     æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "å¿«æ·å‘½ä»¤:"
    echo "  proxy          å¯åŠ¨ä»£ç†æœåŠ¡ï¼ˆé»˜è®¤ï¼‰"
    echo ""
    echo "é…ç½®ä¿¡æ¯:"
    echo "  æœåŠ¡å™¨: 43.160.250.84 (è…¾è®¯äº‘æ–°åŠ å¡)"
    echo "  æœ¬åœ°ç«¯å£: SOCKS5 1080, HTTP 1081"
}

start_proxy() {
    echo "ğŸš€ å¯åŠ¨è…¾è®¯äº‘ç§‘å­¦ä¸Šç½‘æœåŠ¡..."
    "$SCRIPT_DIR/start_tencent_proxy.sh"
}

stop_proxy() {
    echo "ğŸ›‘ åœæ­¢è…¾è®¯äº‘ç§‘å­¦ä¸Šç½‘æœåŠ¡..."
    "$SCRIPT_DIR/stop_tencent_proxy.sh"
}

show_status() {
    echo "ğŸ“Š è…¾è®¯äº‘ç§‘å­¦ä¸Šç½‘çŠ¶æ€"
    echo "===================="
    "$SCRIPT_DIR/status_tencent_proxy.sh"
}

test_connection() {
    echo "ğŸ§ª æµ‹è¯•ç½‘ç»œè¿æ¥"
    echo "=============="
    echo "æµ‹è¯•Googleè¿æ¥..."
    if curl -x http://127.0.0.1:1081 -I https://www.google.com --connect-timeout 10 --max-time 15 2>/dev/null | head -1 | grep -q "200\|301\|302"; then
        echo "âœ… Googleè¿æ¥æˆåŠŸ"
    else
        echo "âŒ Googleè¿æ¥å¤±è´¥"
    fi

    echo "æµ‹è¯•GitHubè¿æ¥..."
    if curl -x http://127.0.0.1:1081 -I https://github.com --connect-timeout 10 --max-time 15 2>/dev/null | head -1 | grep -q "200\|301\|302"; then
        echo "âœ… GitHubè¿æ¥æˆåŠŸ"
    else
        echo "âŒ GitHubè¿æ¥å¤±è´¥"
    fi

    echo "æµ‹è¯•V0.devè¿æ¥..."
    if curl -x http://127.0.0.1:1081 -I https://v0.dev --connect-timeout 10 --max-time 15 2>/dev/null | head -1 | grep -q "200\|301\|302"; then
        echo "âœ… V0.devè¿æ¥æˆåŠŸ"
    else
        echo "âŒ V0.devè¿æ¥å¤±è´¥"
    fi
}

# ä¸»é€»è¾‘
case "${1:-start}" in
    "start"|"")
        start_proxy
        ;;
    "stop")
        stop_proxy
        ;;
    "status")
        show_status
        ;;
    "test")
        test_connection
        ;;
    "help"|"-h"|"--help")
        show_help
        ;;
    *)
        echo "âŒ æ— æ•ˆå‘½ä»¤: $1"
        echo ""
        show_help
        exit 1
        ;;
esac